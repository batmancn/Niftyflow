
## 启动阶段

每台分析器启动时, 首先向控制器发送请求. 获取计数器规则, 以及出口交换机ID,
这里是向控制器监听的队列中发送.

```json
{
  "ACTION": "INIT",
  "ANALYZER_ID": 124         // 分析器ID, 由分析器的配置文件进行配置
}
```


控制器收到报文后, 寻找可用的ID, 进行返回, 同时带上出口交换机的ID, 以及计数器信息
通过控制器进行配置, 可以简化分析器的操作.

```json
{
  "ANALYZER_ID": 124,                    // ID为0, 表示这是一种广播操作.
  "MESSAGE": {                  // 报文主体
    "COMMOND": "INIT",          // 初始化
    "SWH_ID": [
        14, 23, 19, 40
    ],
    "COUNTER": [                // 计数器的filter
        {
            "CNT_ID" : 10,
            "SRC_IP": "192.118.0.2",
            "DST_IP": "192.119.0.1",
            ...
        }
    ]
  }
}
```

> 这里, COUNTER中元素的具体设计如下, 假如不存在, 则空置或是使用null
> 那么, 分析器就不会进行解析了.

```json
{
  "CNT_ID": 10,
  "SRC_IP": "192.118.0.2",
  "DST_IP": "192.119.0.1",
  "SWH_ID": 123, // 截取报文的交换机ID, 不单单指出口报文
  "PTL": 6    // 协议类型
}
```


## 更新出口交换机与计数器信息

### 重载

由控制器主动进行发送指令包重载过程, 重载会导致分析速率下降,
在@热重启部分有讨论该问题

```json
{
  "ANALYZER_ID": 13,             // ID为0, 表示这是一种广播操作.
  "MESSAGE": {          // 报文主体
    "COMMOND": "RELOAD",   // 重载过程, 这里就认为是热重启
    "SWH_ID": [
        14, 23, 19, 40
    ],
    "COUNTER": [                // 计数器的filter
        {
            "CNT_ID" : 1
            "SRC_IP": "192.118.0.2",
            "DST_IP": "192.119.0.1"
        }
    ]
  }
}
```

### 增加删除Counter规则, 以及出口交换机ID

这一操作应该是对每个分析器进行

| COMMAND    | 解释         | 具体报文                  |
| -----      | -----        | ---                       |
| ADD_RULE   | 增加规则     | "COUNTER": [{"ID":1} .. ] |
| DEL_RULE   | 删除规则     | "COUNTER": [1, 2,3]       |
| ADD_SWH_ID | 增加交换机ID | "SWH_ID" : [13, 4, 4]     |
| DEL_SWH_ID | 删除交换机ID | "SWH_ID" : [23,]          |

```json
{
  "ANALYZER_ID": 0,              // ID为0, 表示这是一种广播操作.
  "MESSAGE": {          // 报文主体
    "COMMOND": "ADD_RULE",   // 重载过程, 这里就认为是热重启
    "SWH_ID": [
        14, 23, 19, 40
    ],
    "COUNTER": [                // 计数器的filter
        {
            "CNT_ID" : 1
            "SRC_IP": "192.118.0.2",
            "DST_IP": "192.119.0.1"
        }
    ]
  }
}
```

## 预警信息发送

分析器向控制器的监听队列中发送

```json
{
  "ANALYZER_ID": 10,
  "ACTION": "ALERT",
  "MESSAGE": {
    "START_TIME": "12046980",   // 一天内的时间戳偏移(毫秒级)
    "SRC_IP": "192.118.0.1",
    "DST_IP": "192.168.9.2"
  }
}
```



